# 图片上传功能实现说明

## 功能概述
在聊天对话框中实现了完整的图片上传功能，包括：
- 图片上传（支持拖拽和点击）
- 图片预览和删除
- 图片在消息中的显示
- 多模态消息支持

## 实现内容

### 1. 后端实现

#### 数据模型
- **ChatImage** (`/backend/app/models/chat_image.py`)
  - 存储图片信息（文件名、路径、大小等）
  - 支持缩略图存储

#### API接口
- **POST** `/api/chat/images/upload` - 上传图片
  - 支持多文件上传（最多3张）
  - 自动生成缩略图
  - 文件大小限制（5MB）
  - MIME类型验证

- **GET** `/api/chat/images/view/{filename}` - 获取原图
- **GET** `/api/chat/images/thumb/{filename}` - 获取缩略图
- **DELETE** `/api/chat/images/{image_id}` - 删除图片

#### 图片处理
- 使用PIL生成缩略图（200x200）
- 支持JPEG、PNG、GIF、WebP格式
- 按日期分目录存储

### 2. 前端实现

#### 组件结构
```
src/components/chat/
├── ImageUpload.vue      # 图片上传组件
├── ChatImage.vue        # 图片显示组件
├── InputBar.vue         # 输入框（集成上传）
├── MessageBubble.vue    # 消息气泡（支持图片）
└── ChatWindow.vue       # 聊天窗口
```

#### 主要功能
- 拖拽上传和点击选择
- 上传进度显示
- 图片预览（点击查看大图）
- 图片删除（带确认）
- 多模态消息渲染

## 使用方法

### 上传图片
1. 在聊天输入框左侧点击图片按钮 📷
2. 选择要上传的图片（最多3张）
3. 支持拖拽文件到上传区域
4. 上传成功后图片会显示在输入框上方

### 发送包含图片的消息
- 上传图片后，可以添加文字说明
- 点击发送按钮，图片和文字会一起发送
- 图片会以缩略图形式显示在消息中
- 点击图片可以查看原图

### 删除图片
- 上传后但未发送前，可点击图片上的删除按钮
- 需要确认后才删除

## 技术特点

### 安全性
- 文件类型验证
- 文件大小限制
- MIME类型检查
- 文件魔数验证

### 性能优化
- 自动生成缩略图
- 图片压缩
- 缓存机制
- 异步上传处理

### 用户体验
- 实时上传进度
- 拖拽支持
- 图片预览
- 错误提示

## 配置说明

### 环境变量
```bash
UPLOAD_DIR=/path/to/uploads  # 图片存储目录
MAX_UPLOAD_SIZE=5242880      # 最大文件大小（5MB）
```

### 前端配置
```javascript
// ImageUpload.vue
maxFiles: 3          # 最大上传数量
maxFileSize: 5       # 最大文件大小（MB）
```

## 注意事项

1. **存储空间**：确保上传目录有足够空间
2. **备份**：重要图片建议定期备份
3. **清理**：定期清理未关联的临时图片
4. **权限**：确保web服务有写入权限

## 扩展建议

1. **云存储**：可扩展到S3、阿里云OSS等
2. **OCR识别**：添加文字识别功能
3. **图片编辑**：添加裁剪、旋转等编辑功能
4. **批量操作**：支持批量上传和管理